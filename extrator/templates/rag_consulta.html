{% extends 'base.html' %}
{% block title %}Consultar Banco de Dados com IA{% endblock %}

{% block content %}
<style>
    /* Estilos para a janela de chat */
    #chat-window {
        height: 50vh; /* 50% da altura da tela */
        overflow-y: auto; /* Adiciona barra de rolagem se o conteúdo transbordar */
        background-color: var(--bs-body-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 1rem;
        display: flex;
        flex-direction: column;
    }

    /* Estilos para cada balão de mensagem */
    .message {
        padding: 0.75rem 1rem;
        border-radius: 10px;
        margin-bottom: 0.75rem;
        max-width: 80%;
        line-height: 1.5;
        white-space: pre-wrap; /* Preserva quebras de linha e espaços */
    }

    /* Mensagem do Usuário (azul) */
    .user-message {
        background-color: var(--primary-blue);
        color: #fff;
        align-self: flex-end; /* Alinha à direita */
        margin-left: auto;
    }

    /* Mensagem da IA (cinza escuro) */
    .ai-message {
        background-color: var(--primary-dark);
        color: var(--bs-body-color);
        align-self: flex-start; /* Alinha à esquerda */
        margin-right: auto;
    }

    /* Formulário de input */
    #chat-form {
        display: flex;
        gap: 0.5rem;
    }
    #chat-input {
        flex-grow: 1; /* O input ocupa o máximo de espaço */
    }

    /* Spinner (copiado de upload.html) */
    .spinner { 
        border: 4px solid rgba(56, 139, 253, 0.2); 
        border-left-color: var(--primary-blue); 
        border-radius: 50%; 
        width: 30px; 
        height: 30px; 
        animation: spin 1s linear infinite; 
        margin: 0 auto;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    #loading-spinner {
        display: none; /* Começa escondido */
        align-self: center;
        margin: 1rem;
    }

</style>

<div class="card">
    <div class="card-header">
        <i class="bi bi-robot"></i> Consultar Banco de Dados com IA (RAG)
    </div>
    <div class="card-body">
        
        <div id="chat-window">
            <div class="ai-message message">
                Olá! Eu sou seu assistente de consulta ao banco de dados. O que você gostaria de saber?
            </div>
            <div id="loading-spinner" class="spinner"></div>
        </div>

        <form id="chat-form">
            {% csrf_token %}
            <input type="text" id="chat-input" class="form-control" placeholder="Digite sua pergunta..." autocomplete="off">
            <button type="submit" id="send-btn" class="btn btn-primary">
                <i class="bi bi-send-fill"></i> Enviar
            </button>
        </form>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const chatWindow = document.getElementById('chat-window');
    const loadingSpinner = document.getElementById('loading-spinner');
    const sendBtn = document.getElementById('send-btn');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const processUrl = "{% url 'processar_rag_consulta' %}";

    chatForm.addEventListener('submit', function(event) {
        event.preventDefault();
        
        const pergunta = chatInput.value.trim();
        if (pergunta === '') {
            return;
        }

        addMessageToChat(pergunta, 'user');
        chatInput.value = '';

        loadingSpinner.style.display = 'block';
        sendBtn.disabled = true;


        fetch(processUrl, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 'pergunta': pergunta })
        })
        .then(response => response.json())
        .then(data => {
            if (data.resposta) {
                addMessageToChat(data.resposta, 'ai');
            } else {
                addMessageToChat(`Erro: ${data.error || 'Não foi possível processar.'}`, 'ai');
            }
        })
        .catch(err => {
            addMessageToChat(`Erro de conexão: ${err.message}`, 'ai');
        })
        .finally(() => {
            loadingSpinner.style.display = 'none';
            sendBtn.disabled = false;
        });
    });


    function addMessageToChat(text, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message');
        
        if (sender === 'user') {
            messageDiv.classList.add('user-message');
        } else {
            messageDiv.classList.add('ai-message');
        }

        messageDiv.textContent = text;
        
        chatWindow.insertBefore(messageDiv, loadingSpinner);
        
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }
});
</script>
{% endblock %}